name: Dependency Update

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of update to perform'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - latest
      create_pr:
        description: 'Create PR with updates'
        required: false
        default: true
        type: boolean

jobs:
  dependency-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.14.0

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run maintenance check
        run: pnpm run maintenance

      - name: Update dependencies (patch)
        if: ${{ github.event.inputs.update_type == 'patch' || github.event_name == 'schedule' }}
        run: pnpm update

      - name: Update dependencies (minor)
        if: ${{ github.event.inputs.update_type == 'minor' }}
        run: pnpm update --latest --target minor

      - name: Update dependencies (latest)
        if: ${{ github.event.inputs.update_type == 'latest' }}
        run: pnpm update --latest

      - name: Fix workspace consistency
        run: pnpm run workspace:check

      - name: Run tests after update
        run: pnpm run health-check

      - name: Check for changes
        id: changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
          else
            echo "changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.changes == 'true' && (github.event.inputs.create_pr == 'true' || github.event_name == 'schedule')
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore(deps): update dependencies (${{ github.event.inputs.update_type || 'patch' }})
            
            - Updated dependencies to latest ${{ github.event.inputs.update_type || 'patch' }} versions
            - Ran full health check to ensure compatibility
            - Fixed workspace consistency issues
          title: "chore(deps): update dependencies (${{ github.event.inputs.update_type || 'patch' }})"
          body: |
            ## 📦 Dependency Update
            
            This PR updates dependencies to their latest ${{ github.event.inputs.update_type || 'patch' }} versions.
            
            ### Changes Made
            - ⬆️ Updated dependencies using `pnpm update${{ github.event.inputs.update_type == 'latest' && ' --latest' || '' }}`
            - 🔧 Fixed workspace consistency with manypkg
            - ✅ Ran full health check to ensure everything works
            
            ### Validation
            - [x] Dependencies updated successfully
            - [x] Workspace consistency maintained
            - [x] All quality checks pass
            - [x] Build successful
            
            **Auto-generated by dependency-update workflow**
          branch: chore/dependency-update-${{ github.run_number }}
          delete-branch: true

      - name: Summary
        run: |
          echo "## 📦 Dependency Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Update Type**: ${{ github.event.inputs.update_type || 'patch' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changes Detected**: ${{ steps.changes.outputs.changes }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Health Check**: ✅ Passed" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.changes.outputs.changes }}" == "true" ]]; then
            echo "- **PR Created**: ${{ github.event.inputs.create_pr != 'false' && '✅ Yes' || '❌ No' }}" >> $GITHUB_STEP_SUMMARY
          fi